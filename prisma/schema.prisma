generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  phone         String    @unique
  phoneVerified DateTime?
  passwordHash  String
  
  serialId      String?   @unique
  serialNumber  SerialNumber? @relation(fields: [serialId], references: [id])
  
  role          String    @default("USER") // USER, ADMIN, SUPERADMIN
  isActive      Boolean   @default(true)
  avatarUrl     String?
  adminNotes    String?

  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  
  activities    UserActivity[]
  notifications Notification[]
  downloads     UserDownload[]
  tickets       SupportTicket[]
  ticketMessages TicketMessage[]
  favorites     UserFavorite[]
  accountRequests AccountRequest[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?

  @@map("users")
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("two_factor_tokens")
}

model SerialNumber {
  id          String    @id @default(cuid())
  code        String    @unique // Format: PCMBD-YYYY-XXXX-YYYY
  status      String    @default("AVAILABLE") // AVAILABLE, ASSIGNED, BLOCKED
  batch       String?
  
  user        User?
  
  assignedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  @@map("serial_numbers")
}

// Content Management
model Category {
  id            String    @id @default(cuid())
  name          String
  type          String    // VIDEO, SOFTWARE
  icon          String?
  displayOrder  Int       @default(0)
  
  videos        VideoTutorial[]
  software      Software[]
  
  createdAt     DateTime  @default(now())

  @@map("categories")
}

model VideoTutorial {
  id            String    @id @default(cuid())
  title         String
  description   String?
  youtubeId     String
  categoryId    String
  category      Category  @relation(fields: [categoryId], references: [id])
  
  thumbnailUrl  String?
  duration      Int?      // in seconds
  viewCount     Int       @default(0)
  isPremium     Boolean   @default(false)
  displayOrder  Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  favorites     UserFavorite[] @relation("VideoFavorites")

  @@map("video_tutorials")
}

model Software {
  id            String    @id @default(cuid())
  name          String
  version       String?
  description   String?
  categoryId    String
  category      Category  @relation(fields: [categoryId], references: [id])
  
  fileUrl       String
  fileSize      BigInt?
  iconUrl       String?
  isPremium     Boolean   @default(false)
  downloadCount Int       @default(0)
  
  downloads     UserDownload[]
  mirrors       SoftwareMirror[]
  checksum      String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("software")
}

model SoftwareMirror {
  id         String   @id @default(cuid())
  url        String
  softwareId String
  software   Software @relation(fields: [softwareId], references: [id], onDelete: Cascade)

  @@map("software_mirrors")
}

// Premium Resources
model PremiumAccount {
  id            String    @id @default(cuid())
  serviceName   String
  type          String    // SHARED, PRIVATE
  username      String
  password      String
  notes         String?
  
  maxUsers      Int       @default(1)
  status        String    @default("ACTIVE")
  expiresAt     DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("premium_accounts")
}

model LicenseKey {
  id            String    @id @default(cuid())
  softwareName  String
  key           String
  status        String    @default("AVAILABLE") // AVAILABLE, ASSIGNED
  
  // Could be assigned to a specific user optionally
  assignedToUser String?  
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("license_keys")
}

model AccountRequest {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  resourceType  String    // PREMIUM_ACCOUNT, LICENSE_KEY
  resourceName  String    // e.g. "Windows 11 Pro", "Adobe Creative Cloud"
  reason        String?
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED
  adminNotes    String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("account_requests")
}

// Activities & Logging
model UserDownload {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  softwareId    String
  software      Software  @relation(fields: [softwareId], references: [id])
  
  downloadedAt  DateTime  @default(now())

  @@map("user_downloads")
}

model UserActivity {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  action        String    // LOGIN, DOWNLOAD, WATCH
  details       String?
  ipAddress     String?
  
  createdAt     DateTime  @default(now())

  @@map("user_activities")
}

model Notification {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  title         String
  message       String
  type          String    // INFO, SUCCESS, WARNING
  isRead        Boolean   @default(false)
  
  createdAt     DateTime  @default(now())

  @@map("notifications")
}

model SupportTicket {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  subject       String
  status        String    @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority      String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  
  messages      TicketMessage[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("support_tickets")
}

model TicketMessage {
  id            String    @id @default(cuid())
  ticketId      String
  ticket        SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  message       String
  attachmentUrl String?
  
  createdAt     DateTime  @default(now())

  @@map("ticket_messages")
}

model UserFavorite {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  videoId       String?
  video         VideoTutorial? @relation("VideoFavorites", fields: [videoId], references: [id])
  
  resourceId    String? // Generic ID for other types
  type          String // VIDEO, SOFTWARE, PREMIUM_ACCOUNT
  
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@map("user_favorites")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  category    String   @default("GENERAL") // GENERAL, SMTP, SMS, SECURITY
  description String?
  
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model QuickReply {
  id        String   @id @default(cuid())
  category  String   // e.g., "BIOS", "Serial", "General"
  message   String
  createdAt DateTime @default(now())

  @@map("quick_replies")
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String   // "Namber"
  address   String?
  package   String?
  price     Float?   // "Package/ Price"
  totalBill Float?   // "Total TK"
  
  pendrivePurchaseDate DateTime?
  pendriveSN           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("customers")
}
